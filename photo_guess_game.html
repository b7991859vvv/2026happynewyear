<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>çŒœç…§ç‰‡æ˜¯èª°çš„</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
body { font-family: Arial; padding: 20px; }
.photo { border: 1px solid #ccc; padding: 10px; margin-bottom: 20px; }
img { width: 150px; display:block; }
</style>
</head>

<body>

<h1>çŒœç…§ç‰‡æ˜¯èª°ä¸Šå‚³çš„ ğŸ¯</h1>

<div id="login">
  <input id="username" placeholder="ä½ çš„åå­—">
  <button onclick="login()">é€²å…¥</button>
</div>

<div id="upload" style="display:none">
  <h2>ä¸Šå‚³ 3 å¼µç…§ç‰‡</h2>
  <input type="file" multiple accept="image/*" onchange="uploadPhotos(this)">
</div>

<div id="game" style="display:none">
  <h2>é–‹å§‹ä½œç­”</h2>
  <div id="photos"></div>
  <button onclick="submitAnswers()">æäº¤ç­”æ¡ˆ</button>
</div>

<div id="ranking" style="display:none">
  <h2>æ’è¡Œæ¦œ ğŸ†</h2>
  <ol id="rankList"></ol>
</div>

<script>
/* ğŸ”¥ Firebase è¨­å®š */
firebase.initializeApp({
 apiKey: "AIzaSyC764z-zUOfh8up0DsAJfnc0O0kNGbe-gU",
  authDomain: "project-964620204561833174.firebaseapp.com",
  projectId: "project-964620204561833174",
  storageBucket: "project-964620204561833174.firebasestorage.app",
  messagingSenderId: "212818355600",
  appId: "1:212818355600:web:fc73477c6c66f1ed20ff15",
  measurementId: "G-Y78RK4LX0P"
});

const db = firebase.firestore();
const storage = firebase.storage();

let currentUser = "";

/* ç™»å…¥ */
function login(){
  currentUser = username.value.trim();
  if(!currentUser) return alert("è«‹è¼¸å…¥åå­—");
  login.style.display="none";
  upload.style.display="block";
}

/* ä¸Šå‚³ç…§ç‰‡ */
async function uploadPhotos(input){
  if(input.files.length !== 3) return alert("è«‹ä¸Šå‚³ 3 å¼µ");

  for(let f of input.files){
    const ref = storage.ref(`photos/${currentUser}/${f.name}`);
    await ref.put(f);
    const url = await ref.getDownloadURL();
    await db.collection("photos").add({ owner: currentUser, url });
  }
  upload.style.display="none";
  game.style.display="block";
  loadGame();
}

/* è¼‰å…¥é¡Œç›® */
async function loadGame(){
  const photosSnap = await db.collection("photos").get();
  const users = [...new Set(photosSnap.docs.map(d=>d.data().owner))];
  photos.innerHTML="";

  photosSnap.forEach(doc=>{
    const p = doc.data();
    if(p.owner === currentUser) return;

    photos.innerHTML += `
      <div class="photo">
        <img src="${p.url}">
        ${users.map(u=>`
          <label>
            <input type="radio" name="${doc.id}" value="${u}">${u}
          </label>`).join("")}
      </div>`;
  });
}

/* æäº¤ä¸¦è¨ˆåˆ† */
async function submitAnswers(){
  const photosSnap = await db.collection("photos").get();
  let score = 0;

  for(let doc of photosSnap.docs){
    const p = doc.data();
    if(p.owner === currentUser) continue;

    const checked = document.querySelector(`input[name="${doc.id}"]:checked`);
    if(checked && checked.value === p.owner) score++;
  }

  await db.collection("scores").doc(currentUser).set({
    player: currentUser,
    score,
    finished: true
  });

  game.style.display="none";
  ranking.style.display="block";
  loadRanking();
}

/* æ’è¡Œæ¦œ */
async function loadRanking(){
  const snap = await db.collection("scores")
    .where("finished","==",true)
    .orderBy("score","desc")
    .get();

  rankList.innerHTML="";
  snap.forEach(d=>{
    rankList.innerHTML += `<li>${d.data().player}ï¼š${d.data().score} åˆ†</li>`;
  });
}
</script>

</body>
</html>
